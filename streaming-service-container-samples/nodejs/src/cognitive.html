


<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Azure Kinect Streaming Service - Multiplex Stream Sample</title>
    </head>

    <style>
        .objectRect
        {
            position:               fixed;
            stroke:                 rgb(23, 102, 43);
            stroke-width:           2px;
            fill-opacity:           0;
        }
        
        .faceText
        {
            font-family:           Calibri;
            font-size:             9pt;
            color:                 black;
            text-align:            left;
        }
        
        .faceTextRect
        {
            fill:                  rgb(12, 161, 49);
            stroke:                rgb(12, 161, 49);
            stroke-width:          2px;
            opacity:               0.8;
        }
    </style>    

    <body>
        <div>
            <button id="startStop">Start</button>    
        </div>
        <div style="position:absolute; left: 1%; max-width:48%; max-height:100%">
            <canvas id="sourceStream" width=1280 height=720 style="border:1px solid #000000; max-width: 100%; max-width: 100%;">
        </div>
        <div style="position:absolute; left: 51%; max-width:48%; max-height:100%">
            <div>
                <canvas id="cognitiveResultContent" width=1280 height=720 style="position:relative; border:1px solid #000000; max-width: 100%; max-width: 100%;"></canvas>
            </div>
            <div width=1280 height=720 style="position:absolute; max-height: 100%; max-width: 100%; top:0px;">
                <svg id="cognitiveVisualizationSurface" width=1280 height=720></svg>
            </div>    
        </div>
    
        <script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
        <script type="text/javascript" src='src/js/azureKinect.js'></script>
        <script type="text/javascript" src='src/js/cognitiveServices.js'></script>
        <script type="text/javascript" src='src/js/visualizers.js'></script>
        <script>
            const subscriptionKey = "<Service Subscription Key>";
            const uriBase = "<Endpoint>";
            var azureKinect = new AzureKinect();
            var cognitiveServices = new CognitiveServices(uriBase, subscriptionKey);
            var faceRecognitionVisualization = new FaceRecognitionVisualizer('cognitiveVisualizationSurface', 'cognitiveResultContent');

            var playButton = document.querySelector('#startStop');
            var socket;
            var socketHandler;
            var sourceStream = new Image();
            var cognitiveResult = new Image();

            azureKinect.SetFormat(azureKinect.streamFormat.mjpg);

            // Handle push Start/Stop button event, to start and stop streaming from remote camera
            playButton.onclick = function() 
            {
                console.log(playButton.textContent)
                if (playButton.textContent == 'Start')
                {
                    playButton.textContent = "Stop";
                    socket = new WebSocket('ws://localhost:8888/getStreams?device=k4a&stream=colorCamera&format=MJPG&resolution=720p&framerate=30');
                    socketHandler = new websockHandler(socket);
                }
                else
                {
                    if (socket.readyState == WebSocket.OPEN)
                    {
                        socket.close(1000, "Gracefully closing socket.");
                    }

                    playButton.textContent = "Start";
                }
            }

            // Cognitive service processing response
            window.addEventListener('CognitiveServiceResponse', function(event)
            {
                if (event.detail.service == cognitiveServices.service.faceRecognition ||
                event.detail.service == cognitiveServices.service.objectRecognition)
                {
                    cognitiveResult.src = event.detail.content;
                    faceRecognitionVisualization.Visualize(event.detail.response);
                }
            });

            // Web socket handling methods
            var websockHandler = window.websockHandler = function(socket) 
            {
                this.client = socket;
                this.client.onopen = this.initSocketClient.bind(this);
            };

            websockHandler.prototype.initSocketClient = function( client ) 
            {
                this.client.onmessage = this.receiveSocketMessage.bind(this);
            };

            websockHandler.prototype.receiveSocketMessage = function( event ) 
            {
                ProcessSocketMessage(event);
            };

            // Video displaying methods
            sourceStream.onload = function ()
            {
                var element = document.getElementById('sourceStream');
                var context = element.getContext('2d');

                context.drawImage(sourceStream, 0, 0, element.width, element.height);
            }

            cognitiveResult.onload = function ()
            {
                var element = document.getElementById('cognitiveResultContent');
                var context = element.getContext('2d');

                context.drawImage(cognitiveResult, 0, 0, element.width, element.height);
            }

            // Main method to process content comming from remote camera
            function ProcessSocketMessage(event)
            {
                var imageData = azureKinect.ProcessWebsocketMessage(event);

                if (imageData !== undefined)
                {
                    switch (imageData.format)
                    {
                        case azureKinect.streamFormat.mjpg:
                            sourceStream.src = imageData.image;
                            cognitiveServices.CognitiveServiceRequest(cognitiveServices.service.faceRecognition, event.data);
                            break;
                    }
                }
            }
        </script>
    </body>
</html>