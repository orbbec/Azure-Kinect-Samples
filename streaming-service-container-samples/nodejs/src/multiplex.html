


<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Azure Kinect Streaming Service - Multiplex Stream Sample</title>
    </head>

    <body>
        <div>
            <button id="startStop">Start</button>    
        </div>
        <div style="position:absolute; left: 1%; max-width:48%; max-height:100%">
            <canvas id="depthStream" width=640 height=576 style="border:1px solid #000000; max-width: 100%; max-width: 100%;">
        </div>
        <div style="position:absolute; left: 51%; max-width:48%; max-height:100%">
            <canvas id="irStream" width=640 height=576 style="border:1px solid #000000; max-width: 100%; max-width: 100%;">
        </div>

        <script type="text/javascript" src='src/js/azureKinect.js'></script>
        <script>
            var azureKinect = new AzureKinect();
            var playButton = document.querySelector('#startStop');
            var socket;
            var socketHandler;
            var depthImageWindow = new Image();
            var irImageWindow = new Image();

            // Handle push Start/Stop button event, to start and stop streaming from remote camera
            playButton.onclick = function() 
            {
                console.log(playButton.textContent)
                if (playButton.textContent == 'Start')
                {
                    playButton.textContent = "Stop";
                    socket = new WebSocket('ws://localhost:8888/getStreams?device=k4a&multiplexed=1&stream1=depthCamera&format1=NFOVUnbinned&framerate1=15&rainbowBitmap1=1&stream2=irCamera&format2=NFOVUnbinned&framerate2=15&grayscaleBitmap2=1');
                    socketHandler = new websockHandler(socket);
                }
                else
                {
                    if (socket.readyState == WebSocket.OPEN)
                    {
                        socket.close(1000, "Gracefully closing socket.");
                    }

                    playButton.textContent = "Start";
                }
            }

            // Web socket handling methods
            var websockHandler = window.websockHandler = function(socket) 
            {
                this.client = socket;
                this.client.onopen = this.initSocketClient.bind(this);
            };

            websockHandler.prototype.initSocketClient = function( client ) 
            {
                this.client.onmessage = this.receiveSocketMessage.bind(this);
            };

            websockHandler.prototype.receiveSocketMessage = function( event ) 
            {
                ProcessSocketMessage(event);
            };

            // Video displaying methods
            irImageWindow.onload = function ()
            {
                var element = document.getElementById('irStream');
                var context = element.getContext('2d');

                context.drawImage(irImageWindow, 0, 0, element.width, element.height);
            }

            depthImageWindow.onload = function ()
            {
                var element = document.getElementById('depthStream');
                var context = element.getContext('2d');

                context.drawImage(depthImageWindow, 0, 0, element.width, element.height);
            }

            // Main method to process content comming from remote camera
            function ProcessSocketMessage(event)
            {
                var imageData = azureKinect.ProcessWebsocketMessage(event);

                if (imageData !== undefined)
                {
                    switch (imageData.format)
                    {
                        case azureKinect.streamFormat.depth:
                            depthImageWindow.src = imageData.image;
                            break;
                        case azureKinect.streamFormat.infrared:
                            irImageWindow.src = imageData.image;
                            break;
                    }
                }
            }
        </script>
    </body>
</html>