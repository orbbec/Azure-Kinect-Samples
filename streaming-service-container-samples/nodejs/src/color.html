<!-- Copyright (c) Microsoft Corporation. All rights reserved.
     Licensed under the MIT License. -->

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Azure Kinect Streaming Service - Color Stream Sample</title>
    </head>

    <body>
        <div>
            <button id="startStop">Start</button>    
        </div>
        <div>
            <canvas id="colorStream" width=1280 height=720 style="border:1px solid #000000">
        </div>

        <script type="text/javascript" src='src/js/azureKinect.js'></script>
        <script>
            var azureKinect = new AzureKinect();
            var playButton = document.querySelector('#startStop');
            var socket;
            var socketHandler;
            var colorImageWindow = new Image();

            azureKinect.SetFormat(azureKinect.streamFormat.mjpg);

            // Handle push Start/Stop button event, to start and stop streaming from remote camera
            playButton.onclick = function() 
            {
                console.log(playButton.textContent)
                if (playButton.textContent == 'Start')
                {
                    playButton.textContent = "Stop";
                    socket = new WebSocket('ws://localhost:8888/getStreams?device=k4a&stream=colorCamera&format=MJPG&resolution=720p&framerate=30');
                    socketHandler = new websockHandler(socket);
                }
                else
                {
                    if (socket.readyState == WebSocket.OPEN)
                    {
                        socket.close(1000, "Gracefully closing socket.");
                    }

                    playButton.textContent = "Start";
                }
            }

            // Web socket handling methods
            var websockHandler = window.websockHandler = function(socket) 
            {
                this.client = socket;
                this.client.onopen = this.initSocketClient.bind(this);
            };

            websockHandler.prototype.initSocketClient = function( client ) 
            {
                this.client.onmessage = this.receiveSocketMessage.bind(this);
            };

            websockHandler.prototype.receiveSocketMessage = function( event ) 
            {
                ProcessSocketMessage(event);
            };

            colorImageWindow.onload = function ()
            {
                var element = document.getElementById('colorStream');
                var context = element.getContext('2d');

                context.drawImage(colorImageWindow, 0, 0, element.width, element.height);
            }

            // Main method to process content comming from remote camera
            function ProcessSocketMessage(event)
            {
                var imageData = azureKinect.ProcessWebsocketMessage(event);

                if (imageData !== undefined)
                {
                    switch (imageData.format)
                    {
                        case azureKinect.streamFormat.mjpg:
                            colorImageWindow.src = imageData.image;
                            break;
                    }
                }
            }
        </script>
    </body>
</html>